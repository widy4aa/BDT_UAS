version: '3.8'

services:
  # ============================================
  # PostgreSQL Shards (4 instances)
  # ============================================
  
  postgres-shard-0:
    image: postgres:17
    container_name: postgres_shard_0
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chat_shard_0
    volumes:
      - ./init/shard_0.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_shard_0_data:/var/lib/postgresql/data
    networks:
      - chat_network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 100M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chat_shard_0"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-shard-1:
    image: postgres:17
    container_name: postgres_shard_1
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chat_shard_1
    volumes:
      - ./init/shard_1.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_shard_1_data:/var/lib/postgresql/data
    networks:
      - chat_network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 100M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chat_shard_1"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-shard-2:
    image: postgres:17
    container_name: postgres_shard_2
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chat_shard_2
    volumes:
      - ./init/shard_2.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_shard_2_data:/var/lib/postgresql/data
    networks:
      - chat_network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 100M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chat_shard_2"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-shard-3:
    image: postgres:17
    container_name: postgres_shard_3
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chat_shard_3
    volumes:
      - ./init/shard_3.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_shard_3_data:/var/lib/postgresql/data
    networks:
      - chat_network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 100M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chat_shard_3"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Apache ShardingSphere Proxy
  # ============================================
  
  shardingsphere-proxy:
    image: apache/shardingsphere-proxy:5.4.1
    container_name: sharding_proxy
    ports:
      - "3307:3307"
    volumes:
      - ./shardingsphere/server.yaml:/opt/shardingsphere-proxy/conf/server.yaml
      - ./shardingsphere/config-sharding.yaml:/opt/shardingsphere-proxy/conf/config-sharding.yaml
    networks:
      - chat_network
    depends_on:
      postgres-shard-0:
        condition: service_healthy
      postgres-shard-1:
        condition: service_healthy
      postgres-shard-2:
        condition: service_healthy
      postgres-shard-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/3307' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ============================================
  # Chat Web Application
  # ============================================
  
  chat_web:
    build: .
    container_name: chat_web_sharded
    ports:
      - "5001:5000"
    environment:
      - DB_HOST=shardingsphere-proxy
      - DB_PORT=3307
      - DB_NAME=sharding_db
      - DB_USER=chatuser
      - DB_PASSWORD=chatpass
      - FLASK_ENV=production
      - SECRET_KEY=your-secret-key-here-change-in-production
    networks:
      - chat_network
    depends_on:
      shardingsphere-proxy:
        condition: service_healthy
    restart: unless-stopped

networks:
  chat_network:
    driver: bridge

volumes:
  postgres_shard_0_data:
  postgres_shard_1_data:
  postgres_shard_2_data:
  postgres_shard_3_data:
